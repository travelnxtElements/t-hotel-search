<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../t-shared-lib/t-provider-behavior.html">

<dom-module id="t-hotel-search-provider">
    <template>
        <iron-ajax id="ajaxCall" 
            method="POST"            
            content-type="application/json"
            handle-as="json"
            verbose>
        </iron-ajax>
    </template>
</dom-module>
<script>
Polymer({

    is: 't-hotel-search-provider',
    /*
     * <p>Behaviour to validate ajax parameters and handle error codes.</p>
     */
    behaviors: [TravelNxt.Behaviors.ProviderBehavior],

    listeners: {
        'ajaxCall.response': '_successCallback',
        'ajaxCall.error': '_errorCallback',
        'ajaxCall.request': '_requestCallback'
    },


    search: function(detail){
        //var detail = this;
        var component = this;
        //validate api data before initiating call
        if(this._validateApiMeta()){
            this.$.ajaxCall.url = this._getUrl();
            this.$.ajaxCall.body = JSON.stringify(buildReq(detail));
            this.$.ajaxCall.generateRequest();
        }
        function buildReq(detail){
            var serviceModel = {
                "destination": detail.location,
                "checkInDate": {
                    "date": detail.checkIn,
                    "systemDateTime": component._toSystemDateTimeFormat(new Date(detail.checkIn))  //if detail.checkIn is not mm/dd/yyyy or en-US culture, parse string according to culture / globalization                     
                },
                "checkOutDate": {
                    "date": detail.checkOut,
                    "systemDateTime": component._toSystemDateTimeFormat(new Date(detail.checkOut)) //if detail.checkOut is not mm/dd/yyyy or en-US culture, parse string according to culture / globalization                     
                },
                "rooms": [{
                    "children": {
                        "quantity": detail.childCount,
                        "ages": [],
                        "type": 'Child',
                    },
                    "adults": {
                        "quantity": detail.adultCount,
                        "type": 'Adult',
                        "ages": [],
                    }                    
                }],
                'responseContentType': 'rates',
                "type": 'Hotel'
            };
            //default adult age setup
            if(detail.adultCount){
                for (var i = 0; i < detail.adultCount; i++) {
                    serviceModel.rooms[0].adults.ages.push(25); //TODO: give provision for adult ages also in component api
                };
            }  

            if(detail.childAges){
                for (var i = 0; i < detail.childAges.length; i++) {
                    serviceModel.rooms[0].children.ages.push(detail.childAges[i].age);
                };
            }
            return serviceModel;  
        }
        
    },

    //Mystique specific logic to convert display date to system date (YYYY-MM-DDTHH:MM:SS)
    //TODO: remove if any date parse/format plugin is setup application 
    _toSystemDateTimeFormat: function(dateToFormat){
        if(!dateToFormat)
            return dateToFormat;

        var systemDateTime = dateToFormat.getFullYear() + '-';        
        systemDateTime += (((dateToFormat.getMonth()+'').length == 1) ? '0' + (dateToFormat.getMonth() + 1) : (dateToFormat.getMonth() + 1)) + '-';
        systemDateTime += (((dateToFormat.getDate()+'').length == 1) ? '0' + dateToFormat.getDate() : dateToFormat.getDate());
        return  systemDateTime + 'T00:00:00'
    },

    _requestCallback: function(){
        this.fire('request', this.$.ajaxCall.toRequestOptions(), { bubbles: false });
    },

        /*
         * <p>Success callback</p>
         */
        _successCallback: function(event) {
            this._successHandler(event);
        },


        /*
         * <p>error callback</p>
         */
        _errorCallback: function(event) {
            this._errorHandler(event);
        }

});
</script>
