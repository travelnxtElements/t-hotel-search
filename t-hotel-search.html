<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../t-autosuggest/t-autosuggest.html">
<link rel="import" href="../t-calendar/t-calendar.html">
<link rel="import" href="../t-button/t-button.html">
<link rel="import" href="../t-stepper/t-stepper.html">
<link rel="import" href="../t-dropdown-menu/t-dropdown-menu.html">
<link rel="import" href="../t-notify/t-notify.html">

<dom-module id="t-hotel-search">
    <style>
        :host {
            font-family: var(--primary-font-family);
        }
        .section{
            padding: 0 10px;
        }
        
        .margin-horizontal {
            margin-right: 5px;
        }
        .margin-horizontal:last-of-type {
            margin-right: 0;
        }
        
        .section > .layout {
            margin: 15px 0;
        }
        .dropdown{
            width: 33%;
        }
    </style>
    <template>
        <t-notify id="notify" message="" type="error"></t-notify>
        <div class="section">
            <div class="horizontal flex layout">
                <t-autosuggest id="location" name="location" required selected-item="{{location}}" class="flex" label="Search city, address, zip or landmark" token-param="formattedAddress" error-message="You missed this." ></t-autosuggest>
            </div>
            <div class="horizontal layout">
                <t-calendar class="flex margin-horizontal" required label="Check-in" name="checkIn" id="checkIn" selected-date="{{checkIn}}" error-msg="You missed this." format="mm/dd/yyyy">
                </t-calendar>
                <!-- margin-horizontal is for margin right -->
                <t-calendar class="flex" required label="Check-out" name="checkOut" id="checkOut" selected-date="{{checkOut}}" error-msg="You missed this." format="mm/dd/yyyy">
                </t-calendar>
            </div>
            <div class="horizontal layout">
                <t-stepper class="flex" min="1" max="5" plural-label="Adults" singular-label="Adult" secondary-label="(12+ years)" count="{{adultCount}}" id="adultCount"></t-stepper>
            </div>
            <div class="horizontal layout">
                <t-stepper class="flex" min="0" max="3" secondary-label="(0-11 years)" plural-label="Children" singular-label="Child" count="{{childCount}}" id="childCount"></t-stepper>
            </div>
            <div class="horizontal layout">
                <template is="dom-repeat" items="{{childAges}}" as="item">
                    <t-dropdown-menu class="dropdown margin-horizontal" label="{{_childAgeDropdownLabel(index)}}" required>
                        <paper-menu class="dropdown-content" attr-for-selected="selection" selected="{{item.age}}" selected-attribute="selection">
                            <paper-item selection="0">&lt;1</paper-item>
                            <paper-item selection="1">1</paper-item>
                            <paper-item selection="2">2</paper-item>
                            <paper-item selection="3">3</paper-item>
                            <paper-item selection="4">4</paper-item>
                            <paper-item selection="5">5</paper-item>
                            <paper-item selection="6">6</paper-item>
                            <paper-item selection="7">7</paper-item>
                            <paper-item selection="8">8</paper-item>
                            <paper-item selection="9">9</paper-item>
                            <paper-item selection="10">10</paper-item>
                            <paper-item selection="11">11</paper-item>
                        </paper-menu>
                    </t-dropdown-menu>
                    <!-- <input value="{{age::input}}"> -->
                </template>
            </div>
            <div class="horizontal layout">
                <t-button id="search" class="primary flex" noink label="Search Hotels" on-click="_initiateSearch"></t-button>
            </div>
        </div>
        <div id="providerHolder">
            <content select="#searchProvider"></content>        
        </div>
    </template>
</dom-module>
<script>
Polymer({

    is: 't-hotel-search',

    properties: {

        /* *
         * The location to search from.
         * Must be a value picked from suggested locations.
         */
        location: {
            type: Object,
            value: function() {
                return null
            }
        },

        /**
         * The date of checking in the hotel.
         */
        checkIn: {
            type: String,
            value: '',
            observer: '_checkInChanged'
        },

        /**
         * The date of checking out from the hotel
         */
        checkOut: {
            type: String,
            value: '',
            observer: '_checkOutChanged'
        },

        /**
         * The number of adult guests
         */
        adultCount: {
            type: Number,
            value: 1
        },

        /**
         * The number of child guests
         */
        childCount: {
            type: Number,
            observer: '_childCountChanged'
        },

        /**
         * Child ages ranging from 1-11
         * { age: '' }
         */
        childAges: {
            type: Array,
            value: function() {
                return [];
            }
        },
    
    },

    _provider: null,    

    attached: function(){
        this._checkAndSubscribeProvider();               
    },   

    /**
     * search provider 
     */    
    _checkAndSubscribeProvider: function(){    
        this.set('_provider', Polymer.dom(this).querySelector('#searchProvider'));
        if(!this._provider){
            console.error('no search provider resolved with id #searchProvider');
        }
        if(typeof this._provider.search != 'function'){
            console.error('no "search" function is present in given search provider');
        }        
        this._provider.addEventListener('success', this._successCallback.bind(this));
        this._provider.addEventListener('error', this._errorCallback.bind(this));
    },

    /**
     * Utility function to construcut child age drop down label ex. Child 1
     */
    _childAgeDropdownLabel: function(index) {
        return "Child " + (index + 1);
    },    
    
    /**
     * Observer to keep children count and childAges array in sync
     */
    _childCountChanged: function(newValue, oldValue) {
    	if(oldValue == undefined)  //very first time on element instantiation oldValue will be undefined
    		oldValue = 0;

    	if(newValue > oldValue){
    		for (var i = 0; i < (newValue -  oldValue); i++) {
                //https://github.com/Polymer/polymer/issues/1839 -  
                //keeping above bug, pushing object instead of string/number
    			this.push('childAges', { age: '' });  
    		};
    	}
    	else if(newValue < oldValue){
    		for (var i = 0; i < (oldValue - newValue); i++) {    			
	      		this.pop('childAges');
    		};            
    	}
    },

    /* Observer to handle check in < check out by setting check out min value  */
    _checkInChanged: function() {
        if (this.checkIn != '') {
            this.$.checkOut.picker.set('min', new Date(this.checkIn));
        }
    },

    /* Observer to handle check out > check in by setting check in max value  */
    _checkOutChanged: function() {
        if (this.checkOut != '') {
            this.$.checkIn.picker.set('max', new Date(this.checkOut));
        }
    },

    _initiateSearch: function() {
        //validate controls
        if(this._validateInput() == false)
            return;

        //initiate search    
        this._setUpProviderData ();        
        this._provider.search();

        //show api call progress
        this._showProgress(true);
    },

    _validateInput: function(){        
        var check = true;
        var x = this.querySelectorAll('[required]');
        for (var i = 0; i < x.length; i++) {            
            if (!x[i].validate()) {
                check = false;                            
            }
        }
        return check;
    },

    _setUpProviderData: function(){
        this._provider.location = this.location;        
        this._provider.checkIn = this.checkIn;
        this._provider.checkOut = this.checkOut;
        this._provider.adultCount = this.adultCount;
        this._provider.childCount = this.childCount;
        this._provider.childAges = this.childAges;
    },

    _showProgress: function(inProgress){
        if(inProgress){
            this.$.search.label = 'Searching Hotels...';
            this.$.search.disabled = true;
        }
        else{
            this.$.search.label = 'Search Hotels';
            this.$.search.disabled = false;
        }
    },

    _successCallback: function(event){
        if(event.srcElement == this._provider){ //handle event bubbling case by targeting event soure
            //hide progress
            //this._showProgress(true);
        }
    },

    _errorCallback: function(event){      
        if(event.srcElement == this._provider){ //handle event bubbling case by targeting event soure
            this.$.notify.active = true;
            this.$.notify.message = event.detail;
            
            //hide progress
            this._showProgress(false);
        }
    }
    
});
</script>
